---
# 00-proxmox-base.yml
# Configures a fresh Proxmox VE install:
#   - Switches from enterprise to no-subscription repos
#   - Removes the subscription nag popup
#   - Installs useful base packages

- name: Proxmox base configuration
  hosts: proxmox
  gather_facts: true

  tasks:
    # --- APT Repositories ---

    - name: Disable PVE enterprise repo
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-enterprise.sources
        content: |
          # Disabled by Ansible - no subscription
          # Types: deb
          # URIs: https://enterprise.proxmox.com/debian/pve
          # Suites: {{ ansible_facts['distribution_release'] }}
          # Components: pve-enterprise
          # Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
        owner: root
        group: root
        mode: "0644"

    - name: Disable Ceph enterprise repo
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/ceph.sources
        content: |
          # Disabled by Ansible - no subscription
          # Types: deb
          # URIs: https://enterprise.proxmox.com/debian/ceph-squid
          # Suites: {{ ansible_facts['distribution_release'] }}
          # Components: enterprise
          # Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
        owner: root
        group: root
        mode: "0644"

    - name: Add PVE no-subscription repo
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/pve-no-subscription.sources
        content: |
          Types: deb
          URIs: http://download.proxmox.com/debian/pve
          Suites: {{ ansible_facts['distribution_release'] }}
          Components: pve-no-subscription
          Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
        owner: root
        group: root
        mode: "0644"

    - name: Add Ceph no-subscription repo
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/ceph-no-subscription.sources
        content: |
          Types: deb
          URIs: http://download.proxmox.com/debian/ceph-squid
          Suites: {{ ansible_facts['distribution_release'] }}
          Components: no-subscription
          Signed-By: /usr/share/keyrings/proxmox-archive-keyring.gpg
        owner: root
        group: root
        mode: "0644"

    - name: Update apt cache
      ansible.builtin.apt:
        update_cache: true
        cache_valid_time: 0

    # --- Subscription Nag ---

    - name: Check if subscription nag is already removed
      ansible.builtin.command:
        cmd: grep -c 'nag removed' /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
      register: nag_check
      changed_when: false
      failed_when: false

    - name: Remove subscription nag from web UI
      ansible.builtin.shell:
        cmd: |
          LINE=$(grep -n "gettext('No valid subscription')" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js | head -1 | cut -d: -f1)
          if [ -n "$LINE" ]; then
            PREV=$((LINE - 1))
            sed -i "${PREV}s/Ext\.Msg\.show({/void({ \/\/ nag removed/" /usr/share/javascript/proxmox-widget-toolkit/proxmoxlib.js
          fi
      when: nag_check.stdout | int == 0
      notify: restart pveproxy

    # --- Admin User ---

    - name: Load user secrets
      ansible.builtin.set_fact:
        user_secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets/users.sops.yml') | from_yaml }}"

    - name: Create admin Linux user
      ansible.builtin.user:
        name: "{{ user_secrets.proxmox_admin_user }}"
        groups: sudo
        append: true
        shell: /bin/bash
        create_home: true

    - name: Set admin user password
      ansible.builtin.shell:
        cmd: "echo '{{ user_secrets.proxmox_admin_user }}:{{ user_secrets.proxmox_admin_password }}' | chpasswd"
      changed_when: true
      no_log: true

    - name: Create Proxmox PVE user
      ansible.builtin.command:
        cmd: "pveum user add {{ user_secrets.proxmox_admin_user }}@pam"
      register: pveum_add
      changed_when: pveum_add.rc == 0
      failed_when:
        - pveum_add.rc != 0
        - "'already exists' not in pveum_add.stderr"

    - name: Grant Administrator role
      ansible.builtin.command:
        cmd: "pveum acl modify / -user {{ user_secrets.proxmox_admin_user }}@pam -role Administrator"
      changed_when: true

    # --- Base Packages ---

    - name: Install base packages
      ansible.builtin.apt:
        name:
          - vim
          - htop
          - iotop
          - curl
          - wget
          - tmux
          - lm-sensors
          - ethtool
          - net-tools
          - dnsutils
          - tree
          - jq
          - unzip
          - python3
          - python3-apt
          - nfs-kernel-server
          - samba
        state: present

  handlers:
    - name: restart pveproxy
      ansible.builtin.systemd:
        name: pveproxy
        state: restarted
