---
# 03-core-services.yml
# Deploys the full Docker Compose stack to the Docker host LXC:
#   - Caddy (reverse proxy)
#   - cloudflared (Cloudflare Tunnel)
#   - Arcane (Docker management UI)
#   - Jellyfin (media streaming, VAAPI transcoding)
#   - Sonarr, Radarr, Prowlarr, Lidarr (arr suite)
#   - Jellyseerr (media requests)
#   - Autobrr (automation, behind VPN)
#   - Bazarr (subtitle management)
#   - Linkding (bookmark manager)
#   - Gluetun (VPN tunnel for Prowlarr + Autobrr)
#
# Decrypts SOPS secrets, copies files, templates config, runs compose up.
# Re-runnable: each run copies latest files and recreates containers.
# Config.xml pre-seeding only runs on first deploy (won't overwrite app configs).

# =============================================================
# Play 1: Proxmox host — create media directory structure on ZFS
# =============================================================
- name: Create media directories on NAS
  hosts: proxmox
  gather_facts: false

  pre_tasks:
    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60

  tasks:
    - name: Create media directory structure
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: "100000"
        group: "100000"
        mode: "0755"
      loop:
        - /mnt/nas/media/downloads
        - /mnt/nas/media/downloads/complete
        - /mnt/nas/media/downloads/complete/tv
        - /mnt/nas/media/downloads/complete/movies
        - /mnt/nas/media/downloads/complete/music
        - /mnt/nas/media/tv
        - /mnt/nas/media/movies
        - /mnt/nas/media/music

# =============================================================
# Play 2: Docker host — deploy compose stack
# =============================================================
- name: Deploy core services
  hosts: docker_host
  gather_facts: false

  vars:
    project_dir: /mnt/data/docker/core
    secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../../docker/secrets.sops.yml') | from_yaml }}"
    tunnel_creds: "{{ lookup('community.sops.sops', playbook_dir + '/../../docker/cloudflared/credentials.sops.json') }}"
    tunnel_id: "{{ (tunnel_creds | from_json).TunnelID }}"
    vpn_secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../../docker/gluetun/vpn.sops.yml') | from_yaml }}"
    servarr_apps:
      - name: sonarr
        api_key: "{{ secrets.sonarr_api_key }}"
        port: 8989
      - name: radarr
        api_key: "{{ secrets.radarr_api_key }}"
        port: 7878
      - name: prowlarr
        api_key: "{{ secrets.prowlarr_api_key }}"
        port: 9696
      - name: lidarr
        api_key: "{{ secrets.lidarr_api_key }}"
        port: 8686
  pre_tasks:
    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60

  tasks:

    # --- Directory structure ---

    - name: Create project directories
      ansible.builtin.file:
        path: "{{ item }}"
        state: directory
        owner: root
        group: root
        mode: "0755"
      loop:
        - "{{ project_dir }}"
        - "{{ project_dir }}/caddy"
        - "{{ project_dir }}/cloudflared"
        - "{{ project_dir }}/gluetun"
        - /mnt/data/docker/caddy/data
        - /mnt/data/docker/caddy/config
        - /mnt/data/docker/arcane/data
        - /mnt/data/docker/jellyfin/config
        - /mnt/data/docker/jellyfin/cache
        - /mnt/data/docker/sonarr/config
        - /mnt/data/docker/radarr/config
        - /mnt/data/docker/prowlarr/config
        - /mnt/data/docker/lidarr/config
        - /mnt/data/docker/jellyseerr/config
        - /mnt/data/docker/autobrr/config
        - /mnt/data/docker/bazarr/config
        - /mnt/data/docker/linkding/data

    # --- Pre-seed Servarr config.xml with API keys (first deploy only) ---

    - name: Pre-seed config.xml for Servarr apps
      ansible.builtin.copy:
        dest: "/mnt/data/docker/{{ item.name }}/config/config.xml"
        content: |
          <Config>
            <ApiKey>{{ item.api_key }}</ApiKey>
            <UrlBase></UrlBase>
            <BindAddress>*</BindAddress>
            <Port>{{ item.port }}</Port>
            <AuthenticationMethod>None</AuthenticationMethod>
            <AuthenticationRequired>DisabledForLocalAddresses</AuthenticationRequired>
          </Config>
        owner: root
        group: root
        mode: "0644"
        force: false
      loop: "{{ servarr_apps }}"
      loop_control:
        label: "{{ item.name }}"
      no_log: true

    # --- Pre-seed Autobrr config.toml (first deploy only) ---

    - name: Pre-seed Autobrr config.toml
      ansible.builtin.copy:
        dest: /mnt/data/docker/autobrr/config/config.toml
        content: |
          host = "0.0.0.0"
          port = 7474
          logLevel = "DEBUG"
          sessionSecret = "{{ secrets.autobrr_session_secret }}"
        owner: root
        group: root
        mode: "0644"
        force: false
      no_log: true

    # --- Copy compose files ---

    - name: Copy docker-compose.yml
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../docker/docker-compose.yml"
        dest: "{{ project_dir }}/docker-compose.yml"
        owner: root
        group: root
        mode: "0644"

    - name: Copy Caddyfile
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../docker/caddy/Caddyfile"
        dest: "{{ project_dir }}/caddy/Caddyfile"
        owner: root
        group: root
        mode: "0644"

    # --- Write secrets (decrypted) ---

    - name: Write .env file
      ansible.builtin.copy:
        dest: "{{ project_dir }}/.env"
        content: |
          DOMAIN={{ secrets.domain }}
          ARCANE_ENCRYPTION_KEY={{ secrets.arcane_encryption_key }}
          ARCANE_JWT_SECRET={{ secrets.arcane_jwt_secret }}
          LINKDING_SUPERUSER_NAME={{ secrets.linkding_superuser_name }}
          LINKDING_SUPERUSER_PASSWORD={{ secrets.linkding_superuser_password }}
        owner: root
        group: root
        mode: "0600"

    - name: Write tunnel credentials
      ansible.builtin.copy:
        dest: "{{ project_dir }}/cloudflared/credentials.json"
        content: "{{ tunnel_creds }}"
        owner: "65532"
        group: "65532"
        mode: "0600"

    - name: Write cloudflared config
      ansible.builtin.copy:
        dest: "{{ project_dir }}/cloudflared/config.yml"
        content: |
          tunnel: {{ tunnel_id }}
          credentials-file: /etc/cloudflared/credentials.json

          ingress:
            - service: http://caddy:80
        owner: "65532"
        group: "65532"
        mode: "0644"

    # --- VPN config (Gluetun) ---

    - name: Write VPN OpenVPN config
      ansible.builtin.copy:
        dest: "{{ project_dir }}/gluetun/custom.conf"
        content: "{{ vpn_secrets.ovpn_config }}"
        owner: root
        group: root
        mode: "0600"

    # --- Deploy ---

    - name: Pull latest images
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: "{{ project_dir }}"
      changed_when: true

    - name: Start compose stack
      ansible.builtin.command:
        cmd: docker compose up -d --remove-orphans
        chdir: "{{ project_dir }}"
      changed_when: true

    # --- Verify ---

    - name: Wait for containers to start
      ansible.builtin.pause:
        seconds: 30

    - name: Wait for Gluetun VPN to be healthy
      ansible.builtin.command:
        cmd: docker inspect --format "{% raw %}{{.State.Health.Status}}{% endraw %}" gluetun
      register: gluetun_health
      retries: 12
      delay: 10
      until: gluetun_health.stdout == "healthy"
      changed_when: false

    - name: Show Gluetun health status
      ansible.builtin.debug:
        msg: "Gluetun VPN: {{ gluetun_health.stdout }}"

    - name: Check compose status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: "{{ project_dir }}"
      register: compose_status
      changed_when: false

    - name: Show compose status
      ansible.builtin.debug:
        var: compose_status.stdout_lines

    - name: Check container health
      ansible.builtin.command:
        cmd: docker ps --format "table {% raw %}{{.Names}}\t{{.Status}}\t{{.Ports}}{% endraw %}"
      register: docker_status
      changed_when: false

    - name: Show container status
      ansible.builtin.debug:
        var: docker_status.stdout_lines

    # --- Verify app services ---

    - name: Verify Jellyfin is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "jellyfin.{{ secrets.domain }}"
        status_code: [200, 302]
      register: jellyfin_check
      retries: 3
      delay: 5
      until: jellyfin_check is not failed

    - name: Verify Sonarr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "sonarr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: sonarr_check
      retries: 3
      delay: 5
      until: sonarr_check is not failed

    - name: Verify Radarr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "radarr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: radarr_check
      retries: 3
      delay: 5
      until: radarr_check is not failed

    - name: Verify Prowlarr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "prowlarr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: prowlarr_check
      retries: 3
      delay: 5
      until: prowlarr_check is not failed

    - name: Verify Lidarr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "lidarr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: lidarr_check
      retries: 3
      delay: 5
      until: lidarr_check is not failed

    - name: Verify Jellyseerr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "jellyseerr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: jellyseerr_check
      retries: 3
      delay: 5
      until: jellyseerr_check is not failed

    - name: Verify Autobrr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "autobrr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: autobrr_check
      retries: 3
      delay: 5
      until: autobrr_check is not failed

    - name: Verify Bazarr is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "bazarr.{{ secrets.domain }}"
        status_code: [200, 302]
      register: bazarr_check
      retries: 3
      delay: 5
      until: bazarr_check is not failed

    - name: Verify Linkding is responding
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "links.{{ secrets.domain }}"
        status_code: [200, 302]
      register: linkding_check
      retries: 3
      delay: 5
      until: linkding_check is not failed

    - name: Verify VPN tunnel IP
      ansible.builtin.command: docker exec gluetun wget -qO- https://ipinfo.io/ip
      register: vpn_ip
      changed_when: false
      retries: 3
      delay: 5
      until: vpn_ip is not failed

    - name: Show VPN tunnel IP
      ansible.builtin.debug:
        msg: "VPN tunnel IP: {{ vpn_ip.stdout }} (should NOT be your home IP)"

    - name: Verify GPU passthrough
      ansible.builtin.command: ls -la /dev/dri/
      register: dri_check
      changed_when: false

    - name: Show GPU devices
      ansible.builtin.debug:
        var: dri_check.stdout_lines

    # --- Arcane user setup ---
    # Arcane port is only exposed within Docker network, so we go through Caddy on port 80

    - name: Login to Arcane with default credentials
      ansible.builtin.uri:
        url: "http://localhost:80/api/auth/login"
        method: POST
        headers:
          Host: "arcane.{{ secrets.domain }}"
        body_format: json
        body:
          username: arcane
          password: arcane-admin
        status_code: [200, 401]
      register: arcane_default_login

    - name: Configure Arcane admin user
      when: arcane_default_login.status == 200
      block:
        - name: Create Arcane admin user
          ansible.builtin.uri:
            url: "http://localhost:80/api/users"
            method: POST
            headers:
              Host: "arcane.{{ secrets.domain }}"
              Authorization: "Bearer {{ arcane_default_login.json.data.token }}"
            body_format: json
            body:
              username: "{{ secrets.arcane_admin_user }}"
              password: "{{ secrets.arcane_admin_password }}"
              displayName: "{{ secrets.arcane_admin_user }}"
              email: "admin@{{ secrets.domain }}"
              roles: ["admin"]
            status_code: [200, 201]
          no_log: true

        - name: Login as new Arcane admin
          ansible.builtin.uri:
            url: "http://localhost:80/api/auth/login"
            method: POST
            headers:
              Host: "arcane.{{ secrets.domain }}"
            body_format: json
            body:
              username: "{{ secrets.arcane_admin_user }}"
              password: "{{ secrets.arcane_admin_password }}"
            status_code: 200
          register: arcane_new_login
          no_log: true

        - name: Get default Arcane user ID
          ansible.builtin.uri:
            url: "http://localhost:80/api/users"
            headers:
              Host: "arcane.{{ secrets.domain }}"
              Authorization: "Bearer {{ arcane_new_login.json.data.token }}"
          register: arcane_users

        - name: Delete default Arcane user
          ansible.builtin.uri:
            url: "http://localhost:80/api/users/{{ item.id }}"
            method: DELETE
            headers:
              Host: "arcane.{{ secrets.domain }}"
              Authorization: "Bearer {{ arcane_new_login.json.data.token }}"
            status_code: [200, 204]
          loop: "{{ arcane_users.json.data | selectattr('username', 'equalto', 'arcane') | list }}"
          loop_control:
            label: "{{ item.username }}"
