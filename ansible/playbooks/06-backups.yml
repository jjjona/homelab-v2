---
# 06-backups.yml
# Sets up automated offsite backups using restic to Backblaze B2:
#   - Installs restic
#   - Deploys B2 credentials + restic password as env file
#   - Initializes restic repository on B2 (idempotent)
#   - Deploys backup script with healthchecks.io dead man's switch
#   - Installs daily cron job (3:00 AM)
#   - Log rotation
#
# Prerequisites:
#   - Backblaze B2 bucket + application key created
#   - Healthchecks.io check created (24h period, 6h grace)
#   - Secrets SOPS-encrypted in ansible/secrets/backups.sops.yml

- name: Configure restic backups to Backblaze B2
  hosts: proxmox
  gather_facts: false

  vars:
    backup: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets/backups.sops.yml') | from_yaml }}"
    backup_script: /usr/local/bin/restic-backup.sh
    backup_log: /var/log/restic-backup.log
    env_file: /etc/restic/env
    backup_paths:
      - /mnt/docker-data/docker
      - /mnt/nas/documents
      - /mnt/nas/photos
      - /mnt/nas/books
      - /mnt/nas/share
      - /etc/pve
      - /etc/sanoid
    exclude_patterns:
      - "*.log"
      - "*.tmp"
      - cache
      - Cache
      - __pycache__
      - "*.sock"
      - "*.pid"

  pre_tasks:
    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60

  tasks:

    # --- Install restic ---

    - name: Install restic
      ansible.builtin.apt:
        name: restic
        state: present
        update_cache: true

    # --- Deploy environment file ---

    - name: Create restic config directory
      ansible.builtin.file:
        path: /etc/restic
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Deploy restic environment file
      ansible.builtin.copy:
        dest: "{{ env_file }}"
        content: |
          export B2_ACCOUNT_ID="{{ backup.b2_account_id }}"
          export B2_ACCOUNT_KEY="{{ backup.b2_account_key }}"
          export RESTIC_REPOSITORY="b2:{{ backup.b2_bucket }}"
          export RESTIC_PASSWORD="{{ backup.restic_password }}"
          export HEALTHCHECKS_URL="{{ backup.healthchecks_url }}"
        owner: root
        group: root
        mode: "0600"

    # --- Initialize restic repo ---

    - name: Check if restic repo already exists
      ansible.builtin.shell: |
        source {{ env_file }} && restic snapshots --no-lock 2>&1
      args:
        executable: /bin/bash
      register: restic_check
      changed_when: false
      failed_when: false

    - name: Initialize restic repo on B2
      ansible.builtin.shell: |
        source {{ env_file }} && restic init
      args:
        executable: /bin/bash
      when: restic_check.rc != 0

    # --- Deploy backup script ---

    - name: Deploy restic backup script
      ansible.builtin.copy:
        dest: "{{ backup_script }}"
        content: |
          #!/bin/bash
          # Automated restic backup to Backblaze B2
          # Runs daily via cron at 3:00 AM

          set -euo pipefail

          LOGFILE="{{ backup_log }}"
          ENV_FILE="{{ env_file }}"

          # Load B2 credentials + restic password
          source "$ENV_FILE"

          log() { echo "$(date '+%Y-%m-%d %H:%M:%S'): $*" >> "$LOGFILE"; }

          log "=== Backup starting ==="

          # Signal backup started
          curl -fsS -m 10 --retry 3 "${HEALTHCHECKS_URL}/start" > /dev/null 2>&1 || true

          FAILED=0

          # Run backup
          log "Running restic backup..."
          if restic backup \
          {% for path in backup_paths %}
            {{ path }} \
          {% endfor %}
          {% for pattern in exclude_patterns %}
            --exclude '{{ pattern }}' \
          {% endfor %}
            --no-scan \
            >> "$LOGFILE" 2>&1; then
            log "Backup completed successfully"
          else
            log "ERROR: Backup failed with exit code $?"
            FAILED=1
          fi

          # Prune old snapshots
          if [ "$FAILED" -eq 0 ]; then
            log "Pruning old snapshots..."
            if restic forget --prune \
              --keep-daily 7 \
              --keep-weekly 4 \
              --keep-monthly 6 \
              --keep-yearly 1 \
              >> "$LOGFILE" 2>&1; then
              log "Prune completed successfully"
            else
              log "WARNING: Prune failed with exit code $?"
              FAILED=1
            fi
          fi

          # Report to healthchecks.io
          if [ "$FAILED" -eq 0 ]; then
            curl -fsS -m 10 --retry 3 "${HEALTHCHECKS_URL}" > /dev/null 2>&1 || true
            log "=== Backup finished OK ==="
          else
            curl -fsS -m 10 --retry 3 "${HEALTHCHECKS_URL}/fail" > /dev/null 2>&1 || true
            log "=== Backup finished with ERRORS ==="
          fi
        owner: root
        group: root
        mode: "0755"

    # --- Cron ---

    - name: Install daily backup cron job
      ansible.builtin.cron:
        name: "Restic backup to B2"
        hour: "3"
        minute: "0"
        job: "{{ backup_script }}"
        user: root

    # --- Log rotation ---

    - name: Set up log rotation for backup log
      ansible.builtin.copy:
        dest: /etc/logrotate.d/restic-backup
        content: |
          {{ backup_log }} {
            weekly
            rotate 8
            compress
            missingok
            notifempty
          }
        owner: root
        group: root
        mode: "0644"

    # --- Verify ---

    - name: Verify restic can reach repository
      ansible.builtin.shell: |
        source {{ env_file }} && restic snapshots --no-lock
      args:
        executable: /bin/bash
      register: restic_verify
      changed_when: false

    - name: Show restic snapshots
      ansible.builtin.debug:
        var: restic_verify.stdout_lines

    - name: Show cron job
      ansible.builtin.command: crontab -l
      register: cron_list
      changed_when: false

    - name: Show crontab
      ansible.builtin.debug:
        var: cron_list.stdout_lines
