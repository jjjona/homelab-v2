---
# 07-ai-playground.yml
# Creates the Jade Platform Foundation with two LXCs and Gitea integration:
#   - Jade LXC 201 (.160): Bun + Claude Code + OpenCode CLI + git (runs as `jade` user)
#   - Pandora LXC 202 (.161): Docker Engine + git + traefik-kop (sandbox node)
#   - Gitea on existing docker-host compose stack (git.jnrm.eu, port 3000)
#   - SSH-based git access to Gitea (port 2222) for jade user
#   - MCP servers (jade-knowledge + jade-journal) for both Claude Code and OpenCode
#   - Persona slash commands via jade-prompts repo
#
# 3-node architecture: Jade (.160) / Pandora (.161) / Live (.159)
# jade can SSH into Pandora and Live, push/pull repos from Gitea via SSH.
# traefik-kop on Pandora syncs Docker labels to Traefik via Redis.
# Claude Code / OpenCode auth is manual (interactive login after deploy).
#
# Run with --tags destroy to tear down old LXCs first:
#   ansible-playbook playbooks/07-ai-playground.yml --tags destroy
#
# Safe to re-run: LXC creation skips if already running,
# Gitea user creation skips if users exist.

# =============================================================
# Play 0: Destroy old LXCs (only with --tags destroy)
# =============================================================
- name: Destroy old LXCs
  hosts: proxmox
  gather_facts: false
  tags: [destroy, never]

  tasks:

    - name: Stop and destroy LXC 201 (claude/jade)
      ansible.builtin.shell: pct stop 201 && pct destroy 201
      ignore_errors: true
      changed_when: true

    - name: Stop and destroy LXC 202 (pandora)
      ansible.builtin.shell: pct stop 202 && pct destroy 202
      ignore_errors: true
      changed_when: true

    - name: Show destruction complete
      ansible.builtin.debug:
        msg: "Old LXCs 201 + 202 destroyed. Re-run without --tags destroy to recreate."

# =============================================================
# Play 1: Proxmox — Create Jade LXC 201
# =============================================================
- name: Create Jade LXC
  hosts: proxmox
  gather_facts: false
  tags: [create, jade]

  vars:
    ct_id: 201
    ct_hostname: jade
    ct_ip: 192.168.0.160
    ct_gw: 192.168.0.1
    ct_memory: 8192
    ct_swap: 2048
    ct_cores: 4
    ct_rootfs_size: 20
    ct_template: debian-12-standard_12.12-1_amd64.tar.zst
    ct_template_storage: local
    ssh_pubkey: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFG9NoQSuVYiBD5fib0bN43e2UWwH5iEeDy99cCsHrHC"

  tasks:

    - name: Check if LXC {{ ct_id }} exists
      ansible.builtin.command: pct status {{ ct_id }}
      register: ct_check
      ignore_errors: true
      changed_when: false

    - name: Skip if LXC {{ ct_id }} is already running
      ansible.builtin.debug:
        msg: "LXC {{ ct_id }} already exists ({{ ct_check.stdout | default('') }}), skipping creation"
      when: ct_check.rc == 0

    - name: Create LXC {{ ct_id }}
      when: ct_check.rc != 0
      block:

        - name: Update container template index
          ansible.builtin.command: pveam update
          changed_when: false

        - name: Download Debian CT template
          ansible.builtin.command: >
            pveam download {{ ct_template_storage }} {{ ct_template }}
          register: template_download
          changed_when: "'already exists' not in template_download.stdout"
          failed_when:
            - template_download.rc != 0
            - "'already exists' not in template_download.stderr"

        - name: Write SSH public key to temp file
          ansible.builtin.copy:
            dest: /tmp/ct-ssh-pubkey.pub
            content: "{{ ssh_pubkey }}\n"
            mode: "0600"

        - name: Create LXC {{ ct_id }}
          ansible.builtin.command: >
            pct create {{ ct_id }}
            {{ ct_template_storage }}:vztmpl/{{ ct_template }}
            --hostname {{ ct_hostname }}
            --unprivileged 1
            --features nesting=1,keyctl=1
            --rootfs local-lvm:{{ ct_rootfs_size }}
            --memory {{ ct_memory }}
            --swap {{ ct_swap }}
            --cores {{ ct_cores }}
            --net0 name=eth0,bridge=vmbr0,ip={{ ct_ip }}/24,gw={{ ct_gw }},firewall=0
            --nameserver 1.1.1.1
            --onboot 1
            --start 0
            --ssh-public-keys /tmp/ct-ssh-pubkey.pub

        - name: Start LXC {{ ct_id }}
          ansible.builtin.command: pct start {{ ct_id }}

        - name: Wait for LXC systemd to be ready
          ansible.builtin.command: pct exec {{ ct_id }} -- systemctl is-system-running --wait
          register: systemd_ready
          retries: 12
          delay: 5
          until: systemd_ready.rc == 0 or (systemd_ready.stdout is defined and 'running' in systemd_ready.stdout)
          changed_when: false

        - name: Remove temp SSH key file
          ansible.builtin.file:
            path: /tmp/ct-ssh-pubkey.pub
            state: absent

    - name: Ensure LXC {{ ct_id }} is started
      ansible.builtin.command: pct start {{ ct_id }}
      register: start_result
      failed_when:
        - start_result.rc != 0
        - "'already running' not in start_result.stderr"
      changed_when: start_result.rc == 0

    - name: Verify LXC {{ ct_id }} status
      ansible.builtin.command: pct status {{ ct_id }}
      register: ct_status
      changed_when: false

    - name: Show LXC {{ ct_id }} status
      ansible.builtin.debug:
        var: ct_status.stdout

# =============================================================
# Play 2: Proxmox — Create Pandora LXC 202
# =============================================================
- name: Create Pandora LXC
  hosts: proxmox
  gather_facts: false
  tags: [create, pandora]

  vars:
    ct_id: 202
    ct_hostname: pandora
    ct_ip: 192.168.0.161
    ct_gw: 192.168.0.1
    ct_memory: 8192
    ct_swap: 2048
    ct_cores: 4
    ct_rootfs_size: 50
    ct_template: debian-12-standard_12.12-1_amd64.tar.zst
    ct_template_storage: local
    ssh_pubkey: "ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAIFG9NoQSuVYiBD5fib0bN43e2UWwH5iEeDy99cCsHrHC"

  tasks:

    - name: Check if LXC {{ ct_id }} exists
      ansible.builtin.command: pct status {{ ct_id }}
      register: ct_check
      ignore_errors: true
      changed_when: false

    - name: Skip if LXC {{ ct_id }} is already running
      ansible.builtin.debug:
        msg: "LXC {{ ct_id }} already exists ({{ ct_check.stdout | default('') }}), skipping creation"
      when: ct_check.rc == 0

    - name: Create LXC {{ ct_id }}
      when: ct_check.rc != 0
      block:

        - name: Update container template index
          ansible.builtin.command: pveam update
          changed_when: false

        - name: Download Debian CT template
          ansible.builtin.command: >
            pveam download {{ ct_template_storage }} {{ ct_template }}
          register: template_download
          changed_when: "'already exists' not in template_download.stdout"
          failed_when:
            - template_download.rc != 0
            - "'already exists' not in template_download.stderr"

        - name: Write SSH public key to temp file
          ansible.builtin.copy:
            dest: /tmp/ct-ssh-pubkey.pub
            content: "{{ ssh_pubkey }}\n"
            mode: "0600"

        - name: Create LXC {{ ct_id }}
          ansible.builtin.command: >
            pct create {{ ct_id }}
            {{ ct_template_storage }}:vztmpl/{{ ct_template }}
            --hostname {{ ct_hostname }}
            --unprivileged 1
            --features nesting=1,keyctl=1
            --rootfs local-lvm:{{ ct_rootfs_size }}
            --memory {{ ct_memory }}
            --swap {{ ct_swap }}
            --cores {{ ct_cores }}
            --net0 name=eth0,bridge=vmbr0,ip={{ ct_ip }}/24,gw={{ ct_gw }},firewall=0
            --nameserver 1.1.1.1
            --onboot 1
            --start 0
            --ssh-public-keys /tmp/ct-ssh-pubkey.pub

        - name: Start LXC {{ ct_id }}
          ansible.builtin.command: pct start {{ ct_id }}

        - name: Wait for LXC systemd to be ready
          ansible.builtin.command: pct exec {{ ct_id }} -- systemctl is-system-running --wait
          register: systemd_ready
          retries: 12
          delay: 5
          until: systemd_ready.rc == 0 or (systemd_ready.stdout is defined and 'running' in systemd_ready.stdout)
          changed_when: false

        - name: Remove temp SSH key file
          ansible.builtin.file:
            path: /tmp/ct-ssh-pubkey.pub
            state: absent

    - name: Ensure LXC {{ ct_id }} is started
      ansible.builtin.command: pct start {{ ct_id }}
      register: start_result
      failed_when:
        - start_result.rc != 0
        - "'already running' not in start_result.stderr"
      changed_when: start_result.rc == 0

    - name: Verify LXC {{ ct_id }} status
      ansible.builtin.command: pct status {{ ct_id }}
      register: ct_status
      changed_when: false

    - name: Show LXC {{ ct_id }} status
      ansible.builtin.debug:
        var: ct_status.stdout

# =============================================================
# Play 3: Jade LXC — Install tools + configure
# =============================================================
- name: Install tools on Jade LXC
  hosts: jade
  gather_facts: false
  tags: [jade, tools]

  vars:
    ai_secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets/ai-playground.sops.yml') | from_yaml }}"

  tasks:

    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60

    - name: Gather facts
      ansible.builtin.setup:

    # --- Base packages ---

    - name: Install base packages
      ansible.builtin.apt:
        name:
          - git
          - curl
          - jq
          - ca-certificates
          - gnupg
          - python3
          - sudo
          - unzip
        state: present
        update_cache: true

    # --- Create jade user (Claude Code / OpenCode can't run as root) ---

    - name: Create jade group
      ansible.builtin.group:
        name: jade
        state: present

    - name: Create jade user
      ansible.builtin.user:
        name: jade
        group: jade
        shell: /bin/bash
        groups: sudo
        append: true
        create_home: true

    - name: Allow jade passwordless sudo
      ansible.builtin.copy:
        dest: /etc/sudoers.d/jade
        content: "jade ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: "0440"

    - name: Create jade .ssh directory
      ansible.builtin.file:
        path: /home/jade/.ssh
        state: directory
        owner: jade
        group: jade
        mode: "0700"

    - name: Copy SSH authorized_keys to jade user
      ansible.builtin.copy:
        src: /root/.ssh/authorized_keys
        dest: /home/jade/.ssh/authorized_keys
        owner: jade
        group: jade
        mode: "0600"
        remote_src: true

    # --- Install Bun ---

    - name: Install Bun
      ansible.builtin.shell: curl -fsSL https://bun.sh/install | bash
      become: true
      become_user: jade
      args:
        creates: /home/jade/.bun/bin/bun

    - name: Add Bun to jade PATH in .bashrc
      ansible.builtin.lineinfile:
        path: /home/jade/.bashrc
        line: 'export PATH="$HOME/.bun/bin:$PATH"'
        state: present
      become: true
      become_user: jade

    # --- Install Claude Code CLI ---

    - name: Install Claude Code CLI
      ansible.builtin.shell: curl -fsSL https://claude.ai/install.sh | bash
      become: true
      become_user: jade
      args:
        creates: /home/jade/.local/bin/claude

    # --- Install OpenCode CLI ---

    - name: Install OpenCode CLI
      ansible.builtin.shell: curl -fsSL https://opencode.ai/install | bash
      become: true
      become_user: jade
      args:
        creates: /home/jade/.opencode/bin/opencode
      environment:
        HOME: /home/jade

    - name: Add local bin and opencode to jade PATH in .bashrc
      ansible.builtin.lineinfile:
        path: /home/jade/.bashrc
        line: 'export PATH="$HOME/.local/bin:$HOME/.opencode/bin:$PATH"'
        state: present
      become: true
      become_user: jade

    # --- Configure Claude Code settings ---

    - name: Create Claude Code config directory
      ansible.builtin.file:
        path: /home/jade/.claude
        state: directory
        owner: jade
        group: jade
        mode: "0755"

    - name: Write Claude Code settings.json
      ansible.builtin.copy:
        dest: /home/jade/.claude/settings.json
        content: |
          {
            "permissions": {
              "defaultMode": "bypassPermissions"
            },
            "skipDangerousModePermissionPrompt": true
          }
        owner: jade
        group: jade
        mode: "0644"

    # --- Configure MCP for Claude Code ---

    - name: Write Claude Code MCP config (.claude.json)
      ansible.builtin.copy:
        dest: /home/jade/.claude.json
        content: |
          {
            "projects": {
              "/home/jade": {
                "mcpServers": {
                  "jade-knowledge": {
                    "type": "http",
                    "url": "https://knowledge.jnrm.eu/mcp",
                    "headers": {
                      "Authorization": "Bearer {{ ai_secrets.mcp_claude_knowledge_token }}"
                    }
                  },
                  "jade-journal": {
                    "type": "http",
                    "url": "https://journal.jnrm.eu/mcp",
                    "headers": {
                      "Authorization": "Bearer {{ ai_secrets.mcp_claude_journal_token }}"
                    }
                  }
                }
              }
            }
          }
        owner: jade
        group: jade
        mode: "0600"
      no_log: true

    # --- Configure MCP for OpenCode ---

    - name: Create OpenCode config directory
      ansible.builtin.file:
        path: /home/jade/.config/opencode
        state: directory
        owner: jade
        group: jade
        mode: "0755"

    - name: Write OpenCode config (opencode.json)
      ansible.builtin.copy:
        dest: /home/jade/.config/opencode/opencode.json
        content: |
          {
            "$schema": "https://opencode.ai/config.json",
            "model": "github-copilot/gpt-5-mini",
            "permission": "allow",
            "mcp": {
              "jade-knowledge": {
                "type": "remote",
                "url": "https://knowledge.jnrm.eu/mcp",
                "headers": {
                  "Authorization": "Bearer {{ ai_secrets.mcp_opencode_knowledge_token }}"
                }
              },
              "jade-journal": {
                "type": "remote",
                "url": "https://journal.jnrm.eu/mcp",
                "headers": {
                  "Authorization": "Bearer {{ ai_secrets.mcp_opencode_journal_token }}"
                }
              }
            }
          }
        owner: jade
        group: jade
        mode: "0600"
      no_log: true

    # --- SSH keys ---

    - name: Generate SSH key for Pandora access
      ansible.builtin.command: >
        ssh-keygen -t ed25519 -f /home/jade/.ssh/jade_pandora_ed25519 -N "" -C "jade@jade-lxc"
      args:
        creates: /home/jade/.ssh/jade_pandora_ed25519
      become: true
      become_user: jade

    - name: Generate SSH key for Docker host / Live access
      ansible.builtin.command: >
        ssh-keygen -t ed25519 -f /home/jade/.ssh/jade_docker_ed25519 -N "" -C "jade@jade-lxc-docker"
      args:
        creates: /home/jade/.ssh/jade_docker_ed25519
      become: true
      become_user: jade

    - name: Generate SSH key for Gitea access
      ansible.builtin.command: >
        ssh-keygen -t ed25519 -f /home/jade/.ssh/jade_gitea_ed25519 -N "" -C "jade@jade-lxc-gitea"
      args:
        creates: /home/jade/.ssh/jade_gitea_ed25519
      become: true
      become_user: jade

    - name: Fix SSH key ownership
      ansible.builtin.file:
        path: "{{ item }}"
        owner: jade
        group: jade
      loop:
        - /home/jade/.ssh/jade_pandora_ed25519
        - /home/jade/.ssh/jade_pandora_ed25519.pub
        - /home/jade/.ssh/jade_docker_ed25519
        - /home/jade/.ssh/jade_docker_ed25519.pub
        - /home/jade/.ssh/jade_gitea_ed25519
        - /home/jade/.ssh/jade_gitea_ed25519.pub

    # --- SSH config ---

    - name: Write SSH config
      ansible.builtin.copy:
        dest: /home/jade/.ssh/config
        content: |
          Host pandora
              HostName 192.168.0.161
              User root
              IdentityFile ~/.ssh/jade_pandora_ed25519
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null

          Host live
              HostName 192.168.0.159
              User root
              IdentityFile ~/.ssh/jade_docker_ed25519
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null

          Host gitea
              HostName 192.168.0.159
              Port 2222
              User git
              IdentityFile ~/.ssh/jade_gitea_ed25519
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
        owner: jade
        group: jade
        mode: "0600"

    # --- Store SSH public keys as facts for other plays ---

    - name: Read jade Pandora public key
      ansible.builtin.slurp:
        src: /home/jade/.ssh/jade_pandora_ed25519.pub
      register: jade_pandora_pubkey

    - name: Store jade Pandora public key as fact
      ansible.builtin.set_fact:
        jade_pandora_ssh_pubkey: "{{ jade_pandora_pubkey.content | b64decode | trim }}"
      delegate_to: localhost
      delegate_facts: true

    - name: Read jade Docker host public key
      ansible.builtin.slurp:
        src: /home/jade/.ssh/jade_docker_ed25519.pub
      register: jade_docker_pubkey

    - name: Store jade Docker host public key as fact
      ansible.builtin.set_fact:
        jade_docker_ssh_pubkey: "{{ jade_docker_pubkey.content | b64decode | trim }}"
      delegate_to: localhost
      delegate_facts: true

    - name: Read jade Gitea public key
      ansible.builtin.slurp:
        src: /home/jade/.ssh/jade_gitea_ed25519.pub
      register: jade_gitea_pubkey

    - name: Store jade Gitea public key as fact
      ansible.builtin.set_fact:
        jade_gitea_ssh_pubkey: "{{ jade_gitea_pubkey.content | b64decode | trim }}"
      delegate_to: localhost
      delegate_facts: true

    # --- Git config ---

    - name: Configure git user name
      ansible.builtin.command: git config --global user.name jade
      become: true
      become_user: jade
      changed_when: false

    - name: Configure git user email
      ansible.builtin.command: git config --global user.email jade@jnrm.eu
      become: true
      become_user: jade
      changed_when: false

    - name: Configure git SSH rewrite for Gitea
      ansible.builtin.command: git config --global url."git@gitea:jade/".insteadOf "https://git.jnrm.eu/jade/"
      become: true
      become_user: jade
      changed_when: false

# =============================================================
# Play 4: Pandora LXC — Install Docker + traefik-kop + git
# =============================================================
- name: Install Docker on Pandora LXC
  hosts: pandora
  gather_facts: false
  tags: [pandora, docker]

  tasks:

    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60

    - name: Gather facts
      ansible.builtin.setup:

    # --- Base packages ---

    - name: Install base packages
      ansible.builtin.apt:
        name:
          - git
          - curl
          - jq
          - ca-certificates
          - gnupg
          - python3
        state: present
        update_cache: true

    # --- Authorize Jade's SSH key ---

    - name: Add Jade's SSH key to authorized_keys
      ansible.posix.authorized_key:
        user: root
        key: "{{ hostvars['localhost']['jade_pandora_ssh_pubkey'] }}"
        state: present

    # --- Docker official repo ---

    - name: Create keyrings directory
      ansible.builtin.file:
        path: /etc/apt/keyrings
        state: directory
        mode: "0755"

    - name: Download Docker GPG key
      ansible.builtin.get_url:
        url: https://download.docker.com/linux/debian/gpg
        dest: /etc/apt/keyrings/docker.asc
        mode: "0644"

    - name: Add Docker apt repository
      ansible.builtin.copy:
        dest: /etc/apt/sources.list.d/docker.list
        content: >
          deb [arch=amd64 signed-by=/etc/apt/keyrings/docker.asc]
          https://download.docker.com/linux/debian
          {{ ansible_facts['distribution_release'] }} stable
        mode: "0644"

    # --- Install Docker ---

    - name: Install Docker Engine
      ansible.builtin.apt:
        name:
          - docker-ce
          - docker-ce-cli
          - containerd.io
          - docker-buildx-plugin
          - docker-compose-plugin
        state: present
        update_cache: true

    # --- Configure Docker daemon ---

    - name: Configure Docker daemon
      ansible.builtin.copy:
        dest: /etc/docker/daemon.json
        content: |
          {
            "storage-driver": "overlay2",
            "log-driver": "json-file",
            "log-opts": {
              "max-size": "10m",
              "max-file": "3"
            }
          }
        owner: root
        group: root
        mode: "0644"
      notify: restart docker

    # --- Enable services ---

    - name: Enable Docker and containerd
      ansible.builtin.systemd:
        name: "{{ item }}"
        enabled: true
        state: started
      loop:
        - docker
        - containerd

    # --- Deploy traefik-kop ---

    - name: Create traefik-kop directory
      ansible.builtin.file:
        path: /opt/traefik-kop
        state: directory
        owner: root
        group: root
        mode: "0755"

    - name: Write traefik-kop docker-compose.yml
      ansible.builtin.copy:
        dest: /opt/traefik-kop/docker-compose.yml
        content: |
          services:
            traefik-kop:
              image: ghcr.io/jittering/traefik-kop:latest
              container_name: traefik-kop
              restart: unless-stopped
              volumes:
                - /var/run/docker.sock:/var/run/docker.sock:ro
              environment:
                - REDIS_ADDR=192.168.0.159:6379
                - BIND_IP=192.168.0.161
                - POLL_INTERVAL=5
        owner: root
        group: root
        mode: "0644"

    - name: Pull traefik-kop image
      ansible.builtin.command:
        cmd: docker compose pull
        chdir: /opt/traefik-kop
      changed_when: true

    - name: Start traefik-kop
      ansible.builtin.command:
        cmd: docker compose up -d
        chdir: /opt/traefik-kop
      changed_when: true

    # --- Workspaces foundation ---

    - name: Create workspaces directory
      ansible.builtin.file:
        path: /opt/workspaces
        state: directory
        owner: root
        group: root
        mode: "0755"

    # --- Gitea SSH key for Pandora ---

    - name: Create Pandora .ssh directory
      ansible.builtin.file:
        path: /root/.ssh
        state: directory
        owner: root
        group: root
        mode: "0700"

    - name: Generate SSH key for Gitea access on Pandora
      ansible.builtin.command: >
        ssh-keygen -t ed25519 -f /root/.ssh/pandora_gitea_ed25519 -N "" -C "pandora@pandora-lxc-gitea"
      args:
        creates: /root/.ssh/pandora_gitea_ed25519

    - name: Read Pandora Gitea public key
      ansible.builtin.slurp:
        src: /root/.ssh/pandora_gitea_ed25519.pub
      register: pandora_gitea_pubkey

    - name: Store Pandora Gitea public key as fact
      ansible.builtin.set_fact:
        pandora_gitea_ssh_pubkey: "{{ pandora_gitea_pubkey.content | b64decode | trim }}"
      delegate_to: localhost
      delegate_facts: true

    - name: Write SSH config for Gitea
      ansible.builtin.copy:
        dest: /root/.ssh/config
        content: |
          Host gitea
              HostName 192.168.0.159
              Port 2222
              User git
              IdentityFile ~/.ssh/pandora_gitea_ed25519
              StrictHostKeyChecking no
              UserKnownHostsFile /dev/null
        owner: root
        group: root
        mode: "0600"

    # --- Git config ---

    - name: Configure git user name
      ansible.builtin.command: git config --global user.name jade
      changed_when: false

    - name: Configure git user email
      ansible.builtin.command: git config --global user.email jade@jnrm.eu
      changed_when: false

    - name: Configure git SSH rewrite for Gitea
      ansible.builtin.command: git config --global url."git@gitea:jade/".insteadOf "https://git.jnrm.eu/jade/"
      changed_when: false

    # --- Verify ---

    - name: Check Docker version
      ansible.builtin.command: docker version
      register: docker_version
      changed_when: false

    - name: Show Docker version
      ansible.builtin.debug:
        var: docker_version.stdout_lines

    - name: Check Compose version
      ansible.builtin.command: docker compose version
      register: compose_version
      changed_when: false

    - name: Show Compose version
      ansible.builtin.debug:
        var: compose_version.stdout

    - name: Run hello-world test
      ansible.builtin.command: docker run --rm hello-world
      register: hello_world
      changed_when: false

    - name: Show hello-world output
      ansible.builtin.debug:
        var: hello_world.stdout_lines

    - name: Check traefik-kop status
      ansible.builtin.command:
        cmd: docker compose ps
        chdir: /opt/traefik-kop
      register: kop_status
      changed_when: false

    - name: Show traefik-kop status
      ansible.builtin.debug:
        var: kop_status.stdout_lines

  handlers:
    - name: restart docker
      ansible.builtin.systemd:
        name: docker
        state: restarted


# =============================================================
# Play 5: Docker host — Deploy Gitea + create users + authorize SSH
# =============================================================
- name: Deploy Gitea and configure Docker host
  hosts: docker_host
  gather_facts: false
  tags: [gitea]

  vars:
    project_dir: /mnt/data/docker/core
    secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../../docker/secrets.sops.yml') | from_yaml }}"
    ai_secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets/ai-playground.sops.yml') | from_yaml }}"

  pre_tasks:
    - name: Wait for SSH connection
      ansible.builtin.wait_for_connection:
        timeout: 60

  tasks:

    # --- Create Gitea data directory ---

    - name: Create Gitea data directory
      ansible.builtin.file:
        path: /mnt/data/docker/gitea/data
        state: directory
        owner: "1000"
        group: "1000"
        mode: "0755"

    # --- Copy updated compose ---

    - name: Copy docker-compose.yml
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/../../docker/docker-compose.yml"
        dest: "{{ project_dir }}/docker-compose.yml"
        owner: root
        group: root
        mode: "0644"

    # --- Deploy Gitea ---

    - name: Pull Gitea image
      ansible.builtin.command:
        cmd: docker compose pull gitea
        chdir: "{{ project_dir }}"
      changed_when: true

    - name: Start Gitea container
      ansible.builtin.command:
        cmd: docker compose up -d gitea
        chdir: "{{ project_dir }}"
      changed_when: true

    # --- Wait for Gitea ---

    - name: Wait for Gitea to be ready
      ansible.builtin.uri:
        url: http://127.0.0.1:3000
        status_code: [200, 302]
      register: gitea_ready
      retries: 12
      delay: 10
      until: gitea_ready is not failed

    - name: Show Gitea status
      ansible.builtin.debug:
        msg: "Gitea is up (HTTP {{ gitea_ready.status }})"

    # --- Create admin user (jjjona) ---

    - name: Check existing Gitea users
      ansible.builtin.command:
        cmd: docker exec --user 1000 gitea gitea admin user list
      register: gitea_users
      changed_when: false

    - name: Create Gitea admin user (jjjona)
      ansible.builtin.command:
        cmd: >
          docker exec --user 1000 gitea gitea admin user create
          --username {{ ai_secrets.gitea_admin_user }}
          --password {{ ai_secrets.gitea_admin_password }}
          --email {{ ai_secrets.gitea_admin_email }}
          --admin
          --must-change-password=false
      when: ai_secrets.gitea_admin_user not in gitea_users.stdout
      no_log: true

    # --- Create jade user ---

    - name: Create Gitea jade user
      ansible.builtin.command:
        cmd: >
          docker exec --user 1000 gitea gitea admin user create
          --username {{ ai_secrets.gitea_jade_user }}
          --password {{ ai_secrets.gitea_jade_password }}
          --email {{ ai_secrets.gitea_jade_email }}
          --must-change-password=false
      when: ai_secrets.gitea_jade_user not in gitea_users.stdout
      no_log: true

    # --- Generate Gitea access token for jade (API access) ---

    - name: Check existing Gitea tokens
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/users/{{ ai_secrets.gitea_jade_user }}/tokens"
        method: GET
        user: "{{ ai_secrets.gitea_jade_user }}"
        password: "{{ ai_secrets.gitea_jade_password }}"
        force_basic_auth: true
        status_code: [200]
      register: gitea_existing_tokens
      no_log: true

    - name: Delete old jade-api token if present
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/users/{{ ai_secrets.gitea_jade_user }}/tokens/{{ item.id }}"
        method: DELETE
        user: "{{ ai_secrets.gitea_jade_user }}"
        password: "{{ ai_secrets.gitea_jade_password }}"
        force_basic_auth: true
        status_code: [204]
      loop: "{{ gitea_existing_tokens.json | selectattr('name', 'equalto', 'jade-api') | list }}"
      loop_control:
        label: "{{ item.name }}"
      no_log: true

    - name: Generate fresh Gitea access token for jade
      ansible.builtin.command:
        cmd: >
          docker exec --user 1000 gitea gitea admin user generate-access-token
          --username {{ ai_secrets.gitea_jade_user }}
          --token-name jade-api
          --scopes all
          --raw
      register: jade_gitea_token_result
      no_log: true

    - name: Store jade Gitea token as fact
      ansible.builtin.set_fact:
        jade_gitea_token: "{{ jade_gitea_token_result.stdout | trim }}"
      delegate_to: localhost
      delegate_facts: true
      no_log: true

    # --- Register Jade's SSH key with Gitea ---

    - name: List existing SSH keys in Gitea
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/user/keys"
        method: GET
        headers:
          Authorization: "token {{ hostvars['localhost']['jade_gitea_token'] }}"
        status_code: [200]
      register: gitea_ssh_keys
      no_log: true

    - name: Delete old jade-lxc SSH key
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/user/keys/{{ item.id }}"
        method: DELETE
        headers:
          Authorization: "token {{ hostvars['localhost']['jade_gitea_token'] }}"
        status_code: [204]
      loop: "{{ gitea_ssh_keys.json | selectattr('title', 'equalto', 'jade-lxc') | list }}"
      loop_control:
        label: "{{ item.title }}"
      no_log: true
      when: gitea_ssh_keys.json | selectattr('title', 'equalto', 'jade-lxc') | list | length > 0

    - name: Register Jade's SSH key with Gitea
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/user/keys"
        method: POST
        headers:
          Authorization: "token {{ hostvars['localhost']['jade_gitea_token'] }}"
          Content-Type: "application/json"
        body_format: json
        body:
          title: "jade-lxc"
          key: "{{ hostvars['localhost']['jade_gitea_ssh_pubkey'] }}"
        status_code: [201]
      no_log: true

    # --- Register Pandora's SSH key with Gitea ---

    - name: Delete old pandora-lxc SSH key
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/user/keys/{{ item.id }}"
        method: DELETE
        headers:
          Authorization: "token {{ hostvars['localhost']['jade_gitea_token'] }}"
        status_code: [204]
      loop: "{{ gitea_ssh_keys.json | selectattr('title', 'equalto', 'pandora-lxc') | list }}"
      loop_control:
        label: "{{ item.title }}"
      no_log: true
      when: gitea_ssh_keys.json | selectattr('title', 'equalto', 'pandora-lxc') | list | length > 0

    - name: Register Pandora's SSH key with Gitea
      ansible.builtin.uri:
        url: "http://127.0.0.1:3000/api/v1/user/keys"
        method: POST
        headers:
          Authorization: "token {{ hostvars['localhost']['jade_gitea_token'] }}"
          Content-Type: "application/json"
        body_format: json
        body:
          title: "pandora-lxc"
          key: "{{ hostvars['localhost']['pandora_gitea_ssh_pubkey'] }}"
        status_code: [201]
      no_log: true

    # --- Authorize Jade's SSH key for Docker host ---

    - name: Add Jade's Docker host SSH key to authorized_keys
      ansible.posix.authorized_key:
        user: root
        key: "{{ hostvars['localhost']['jade_docker_ssh_pubkey'] }}"
        state: present

    # --- Verify Gitea via Traefik ---

    - name: Verify Gitea via Traefik
      ansible.builtin.uri:
        url: "http://localhost:80/"
        headers:
          Host: "git.{{ secrets.domain }}"
        status_code: [200, 302, 401]
      register: gitea_traefik_check
      retries: 3
      delay: 5
      until: gitea_traefik_check is not failed

    - name: Show Gitea via Traefik result
      ansible.builtin.debug:
        msg: "Gitea via Traefik: HTTP {{ gitea_traefik_check.status }} (401 = tinyauth protecting, expected)"

# =============================================================
# Play 6: Jade + Pandora — Git credentials + repos
# =============================================================
- name: Configure git on Jade LXC
  hosts: jade
  gather_facts: false
  tags: [git, jade]

  vars:
    ai_secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets/ai-playground.sops.yml') | from_yaml }}"

  tasks:

    # --- HTTP token backup for Gitea API access ---

    - name: Configure git credential helper
      ansible.builtin.command: git config --global credential.helper store
      become: true
      become_user: jade
      changed_when: false

    - name: Write git credentials file (HTTP backup)
      ansible.builtin.copy:
        dest: /home/jade/.git-credentials
        content: "http://{{ ai_secrets.gitea_jade_user }}:{{ hostvars['localhost']['jade_gitea_token'] }}@192.168.0.159:3000\n"
        owner: jade
        group: jade
        mode: "0600"
      no_log: true

    # --- Verify SSH to Pandora and Live ---

    - name: Verify SSH from Jade to Pandora
      ansible.builtin.command: ssh pandora whoami
      become: true
      become_user: jade
      register: ssh_pandora_test
      changed_when: false

    - name: Show Pandora SSH test result
      ansible.builtin.debug:
        msg: "SSH Jade → Pandora: {{ ssh_pandora_test.stdout }}"

    - name: Verify SSH from Jade to Live
      ansible.builtin.command: ssh live whoami
      become: true
      become_user: jade
      register: ssh_live_test
      changed_when: false

    - name: Show Live SSH test result
      ansible.builtin.debug:
        msg: "SSH Jade → Live: {{ ssh_live_test.stdout }}"

    # --- Clone jade-prompts and set up commands ---

    - name: Clone jade-prompts from Gitea
      ansible.builtin.git:
        repo: git@gitea:jade/jade-prompts.git
        dest: /home/jade/jade-prompts
        accept_hostkey: true
      become: true
      become_user: jade
      ignore_errors: true
      register: jade_prompts_clone

    - name: Show jade-prompts clone result
      ansible.builtin.debug:
        msg: "{{ 'jade-prompts cloned successfully' if jade_prompts_clone is succeeded else 'jade-prompts clone failed (repo may not exist yet on Gitea) — clone manually after backup restore' }}"

    - name: Create Claude Code commands directory
      ansible.builtin.file:
        path: /home/jade/.claude/commands
        state: directory
        owner: jade
        group: jade
        mode: "0755"

    - name: Symlink persona commands for Claude Code
      ansible.builtin.file:
        src: "/home/jade/jade-prompts/commands/{{ item }}"
        dest: "/home/jade/.claude/commands/{{ item }}"
        state: link
        owner: jade
        group: jade
      loop:
        - persona-architect.md
        - persona-designer.md
        - persona-developer.md
        - persona-devops.md
        - persona-researcher.md
        - persona-trader.md
        - persona-writer.md
      when: jade_prompts_clone is succeeded

    - name: Create OpenCode commands directory
      ansible.builtin.file:
        path: /home/jade/.config/opencode/commands
        state: directory
        owner: jade
        group: jade
        mode: "0755"

    - name: Symlink persona commands for OpenCode
      ansible.builtin.file:
        src: "/home/jade/jade-prompts/commands/{{ item }}"
        dest: "/home/jade/.config/opencode/commands/{{ item }}"
        state: link
        owner: jade
        group: jade
      loop:
        - persona-architect.md
        - persona-designer.md
        - persona-developer.md
        - persona-devops.md
        - persona-researcher.md
        - persona-trader.md
        - persona-writer.md
      when: jade_prompts_clone is succeeded

    # --- Clone jade-soul and set up CLAUDE.md ---

    - name: Clone jade-soul from Gitea
      ansible.builtin.git:
        repo: git@gitea:jade/jade-soul.git
        dest: /home/jade/jade-soul
        accept_hostkey: true
      become: true
      become_user: jade
      ignore_errors: true
      register: jade_soul_clone

    - name: Copy jade-seed.md to CLAUDE.md
      ansible.builtin.copy:
        src: /home/jade/jade-soul/jade-seed.md
        dest: /home/jade/.claude/CLAUDE.md
        owner: jade
        group: jade
        mode: "0644"
        remote_src: true
      when: jade_soul_clone is succeeded

    - name: Show jade-soul result
      ansible.builtin.debug:
        msg: "{{ 'CLAUDE.md written from jade-seed.md' if jade_soul_clone is succeeded else 'jade-soul clone failed (repo may not exist yet) — copy jade-seed.md manually after backup restore' }}"

- name: Configure git on Pandora LXC
  hosts: pandora
  gather_facts: false
  tags: [git, pandora]

  vars:
    ai_secrets: "{{ lookup('community.sops.sops', playbook_dir + '/../secrets/ai-playground.sops.yml') | from_yaml }}"

  tasks:

    # --- HTTP token backup for Gitea API access ---

    - name: Configure git credential helper
      ansible.builtin.command: git config --global credential.helper store
      changed_when: false

    - name: Write git credentials file (HTTP backup)
      ansible.builtin.copy:
        dest: /root/.git-credentials
        content: "http://{{ ai_secrets.gitea_jade_user }}:{{ hostvars['localhost']['jade_gitea_token'] }}@192.168.0.159:3000\n"
        owner: root
        group: root
        mode: "0600"
      no_log: true

# =============================================================
# Play 7: Verification
# =============================================================
- name: Verify AI Playground
  hosts: proxmox
  gather_facts: false
  tags: [verify]

  tasks:

    - name: Show running LXCs
      ansible.builtin.command: pct list
      register: pct_list
      changed_when: false

    - name: Show LXC list
      ansible.builtin.debug:
        var: pct_list.stdout_lines

    - name: Verify Jade LXC 201 is running
      ansible.builtin.assert:
        that: "'201' in pct_list.stdout"
        fail_msg: "LXC 201 (jade) is not in pct list"

    - name: Verify Pandora LXC 202 is running
      ansible.builtin.assert:
        that: "'202' in pct_list.stdout"
        fail_msg: "LXC 202 (pandora) is not in pct list"

- name: Final checks on Jade
  hosts: jade
  gather_facts: false
  tags: [verify]

  tasks:

    - name: Verify jade user exists
      ansible.builtin.command: id jade
      register: jade_user_check
      changed_when: false

    - name: Show jade user info
      ansible.builtin.debug:
        msg: "Jade user: {{ jade_user_check.stdout }}"

    - name: Verify Claude Code installed
      ansible.builtin.command: /home/jade/.local/bin/claude --version
      become: true
      become_user: jade
      register: claude_ver
      changed_when: false

    - name: Show Claude Code version
      ansible.builtin.debug:
        msg: "Claude Code: {{ claude_ver.stdout }}"

    - name: Verify OpenCode installed
      ansible.builtin.stat:
        path: /home/jade/.opencode/bin/opencode
      register: opencode_bin

    - name: Show OpenCode status
      ansible.builtin.debug:
        msg: "OpenCode: {{ 'installed at ~/.opencode/bin/opencode' if opencode_bin.stat.exists else 'NOT FOUND' }}"

    - name: Verify Bun installed
      ansible.builtin.shell: /home/jade/.bun/bin/bun --version
      become: true
      become_user: jade
      register: bun_ver
      changed_when: false

    - name: Show Bun version
      ansible.builtin.debug:
        msg: "Bun: {{ bun_ver.stdout }}"

    - name: Verify CLAUDE.md exists
      ansible.builtin.stat:
        path: /home/jade/.claude/CLAUDE.md
      register: claude_md_stat

    - name: Show CLAUDE.md status
      ansible.builtin.debug:
        msg: "{{ 'CLAUDE.md exists' if claude_md_stat.stat.exists else 'CLAUDE.md missing — copy jade-seed.md manually' }}"

    - name: Verify MCP config exists
      ansible.builtin.stat:
        path: /home/jade/.claude.json
      register: claude_json_stat

    - name: Show MCP config status
      ansible.builtin.debug:
        msg: "{{ '.claude.json MCP config exists' if claude_json_stat.stat.exists else '.claude.json missing!' }}"

    - name: Verify OpenCode config exists
      ansible.builtin.stat:
        path: /home/jade/.config/opencode/opencode.json
      register: opencode_json_stat

    - name: Show OpenCode config status
      ansible.builtin.debug:
        msg: "{{ 'opencode.json config exists' if opencode_json_stat.stat.exists else 'opencode.json missing!' }}"

    - name: Check Claude Code commands
      ansible.builtin.command: ls /home/jade/.claude/commands/
      register: claude_commands
      changed_when: false
      ignore_errors: true

    - name: Show Claude Code commands
      ansible.builtin.debug:
        msg: "Claude commands: {{ claude_commands.stdout_lines | default(['none — jade-prompts not cloned']) }}"

    - name: Verify git SSH access to Gitea
      ansible.builtin.command: ssh gitea -T
      become: true
      become_user: jade
      register: git_ssh_test
      changed_when: false
      ignore_errors: true

    - name: Show git SSH test result
      ansible.builtin.debug:
        msg: "Git SSH: {{ git_ssh_test.stderr | default(git_ssh_test.stdout) }}"

- name: Final checks on Pandora
  hosts: pandora
  gather_facts: false
  tags: [verify]

  tasks:

    - name: Verify Docker on Pandora
      ansible.builtin.command: docker version --format "Docker {{ '{{' }}.Server.Version{{ '}}' }}"
      register: docker_ver
      changed_when: false

    - name: Show Docker version
      ansible.builtin.debug:
        msg: "Pandora Docker: {{ docker_ver.stdout }}"

    - name: Verify traefik-kop is running
      ansible.builtin.command:
        cmd: docker compose ps --format json
        chdir: /opt/traefik-kop
      register: kop_check
      changed_when: false

    - name: Show traefik-kop status
      ansible.builtin.debug:
        var: kop_check.stdout_lines

    - name: Verify Pandora git SSH access to Gitea
      ansible.builtin.command: ssh gitea -T
      register: pandora_git_test
      changed_when: false
      ignore_errors: true

    - name: Show Pandora git SSH result
      ansible.builtin.debug:
        msg: "Pandora Git SSH: {{ pandora_git_test.stderr | default(pandora_git_test.stdout) }}"

    - name: Verify workspaces directory
      ansible.builtin.stat:
        path: /opt/workspaces
      register: workspaces_stat

    - name: Show workspaces status
      ansible.builtin.debug:
        msg: "{{ '/opt/workspaces exists' if workspaces_stat.stat.exists else '/opt/workspaces missing!' }}"

- name: Summary
  hosts: localhost
  gather_facts: false
  connection: local
  tags: [verify]

  tasks:
    - name: Show deployment summary
      ansible.builtin.debug:
        msg:
          - "=== Jade Platform Foundation Deployed ==="
          - "Jade LXC 201: 192.168.0.160 (Bun + Claude Code + OpenCode as 'jade' user)"
          - "Pandora LXC 202: 192.168.0.161 (Docker + traefik-kop + workspaces)"
          - "Gitea: http://192.168.0.159:3000 (git.jnrm.eu, SSH port 2222)"
          - "SSH: jade → pandora (.161), jade → live (.159), jade → gitea (SSH)"
          - "MCP: jade-knowledge + jade-journal on both Claude Code and OpenCode"
          - ""
          - "3-Node Architecture:"
          - "  Jade (.160)   = brain (Claude Code + OpenCode)"
          - "  Pandora (.161) = sandbox (Docker workspaces)"
          - "  Live (.159)    = production (Traefik + services)"
          - ""
          - "Next steps:"
          - "  1. SSH to Jade LXC: ssh jade (from laptop)"
          - "  2. Run 'claude' for interactive login (OAuth)"
          - "  3. Run 'opencode' for API key setup"
          - "  4. Clone remaining repos from Gitea as needed"
